{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[338],{692:function(e,s,t){\"use strict\";t.r(s);var a=t(42),n=Object(a.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":e.$parent.slotKey}},[t(\"h2\",{attrs:{id:\"导读\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#导读\"}},[e._v(\"#\")]),e._v(\" 导读\")]),e._v(\" \"),t(\"p\",[e._v(\"本节标题：「建造毛坯」- CSS 资源处理\")]),e._v(\" \"),t(\"p\",[e._v(\"本节主旨：CSS 模块无法在服务端解析，通用的 CSS 资源处理方式\")]),e._v(\" \"),t(\"p\",[e._v(\"本节配套代码：\")]),e._v(\" \"),t(\"p\",[t(\"a\",{attrs:{href:\"https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-css\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-css\"),t(\"OutboundLink\")],1)]),e._v(\" \"),t(\"h1\",{attrs:{id:\"正文\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#正文\"}},[e._v(\"#\")]),e._v(\" 正文\")]),e._v(\" \"),t(\"p\",[e._v(\"从我们开始搭建应用骨架到这里，这一路我们发现了很多问题，也解决了很多问题,这个收获是巨大的。但总感觉少点什么，期间完全没有涉及到 \"),t(\"code\",[e._v(\"css\")]),e._v(\" ，一个完整的项目怎么能缺少 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 呢？\")]),e._v(\" \"),t(\"p\",[e._v(\"所以本节开始，我们来把 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 融合到我们的应用骨架里，达到可以给组件添加样式，美化页面的目的。\")]),e._v(\" \"),t(\"p\",[e._v(\"不就是支持 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 嘛，配置几个 \"),t(\"code\",[e._v(\"loader\")]),e._v(\" 就完事了。\")]),e._v(\" \"),t(\"p\",[e._v(\"真的这么简单吗？\")]),e._v(\" \"),t(\"p\",[e._v(\"接下来，我们一步一步的实现应用骨架对 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 的支持。\")]),e._v(\" \"),t(\"h1\",{attrs:{id:\"安装所需-loader\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#安装所需-loader\"}},[e._v(\"#\")]),e._v(\" 安装所需 loader\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"npm i sass-loader style-loader postcss-loader css-loader autoprefixer\\n\\n\")])])]),t(\"p\",[e._v(\"使用\"),t(\"code\",[e._v(\"sass\")]),e._v(\"预编译，使用\"),t(\"code\",[e._v(\"postcss-loader + autoprefixer\")]),e._v(\" 为选择器增加浏览器前缀\")]),e._v(\" \"),t(\"h1\",{attrs:{id:\"浏览器端-loader-配置\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#浏览器端-loader-配置\"}},[e._v(\"#\")]),e._v(\" 浏览器端 - loader 配置\")]),e._v(\" \"),t(\"p\",[e._v(\"加入 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 的相关\"),t(\"code\",[e._v(\"loader\")]),e._v(\"配置，开发环境中使\"),t(\"code\",[e._v(\"css\")]),e._v(\"打包进 \"),t(\"code\",[e._v(\"js\")]),e._v(\"，\"),t(\"code\",[e._v(\"style-loader\")]),e._v(\"会帮助我们将 \"),t(\"code\",[e._v(\"css\")]),e._v(\"内联在页面内。\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"// webpack/webpack.dev.config.js\\n//webpack 配置文件\\nconst path = require('path')\\nconst resolvePath = (pathstr) => path.resolve(__dirname, pathstr);\\n\\nmodule.exports = {\\n    mode: 'development',\\n    entry: resolvePath('../src/client/app/index.js'),//入口文件\\n    output: {\\n        filename: 'index.js',\\n        path: resolvePath('../dist/static')\\n    },\\n    module: {\\n        rules: [{\\n                test: /\\\\.jsx?$/,\\n                loader: 'babel-loader',\\n                exclude: /node_modules/\\n            },\\n            {\\n                + test: /\\\\.(sa|sc|c)ss$/,\\n                + use: [\\n                    {\\n                        loader: \\\"css-loader\\\",\\n                    },\\n                    {\\n                        loader: \\\"postcss-loader\\\"\\n                    },\\n                    {\\n                        loader: \\\"sass-loader\\\"\\n                    }\\n            },\\n                {\\n                        test: /\\\\.(png|jpg|gif)$/,\\n                        use: [{\\n                            loader: 'file-loader',\\n                            options: {\\n                                name: 'img/[name].[ext]'//配置图片的输出路径和名称\\n                            }\\n                }]\\n            ]\\n            },\\n        ]\\n    }\\n}\\n\\n\\n\")])])]),t(\"p\",[e._v(\"配置\"),t(\"code\",[e._v(\"autoprefixer\")]),e._v(\"完成 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 前缀转换\")]),e._v(\" \"),t(\"p\",[e._v(\"在项目根目录创建\"),t(\"code\",[e._v(\"postcss.config.js\")]),e._v(\"文件进行配置,也可以直接和 \"),t(\"code\",[e._v(\"loader\")]),e._v(\" 写在一起，看个人习惯。\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"module.exports = {\\n    plugins: [require('autoprefixer')]  // 引用该插件\\n}\\n\\n\")])])]),t(\"p\",[e._v(\"上面我们就完成了，针对浏览器端的 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 配置。\")]),e._v(\" \"),t(\"h1\",{attrs:{id:\"添加css测试代码\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#添加css测试代码\"}},[e._v(\"#\")]),e._v(\" 添加css测试代码\")]),e._v(\" \"),t(\"p\",[e._v(\"给\"),t(\"code\",[e._v(\"layout\")]),e._v(\"组件添加\"),t(\"code\",[e._v(\"css\")]),e._v(\"，作为全局样式\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"// ./src/client/app/layout.css\\n\\nbody {\\n  background-color: #f4f5f5;\\n}\\n\\n.layout-box {\\n  max-width: 750px;\\n  margin: 0 auto;\\n  text-align: center;\\n  background: #fff;\\n}\\n\\n.layout-box h1 {\\n  margin-top: 20px;\\n  margin-top: 20px;\\n}\\n\\n\\n\")])])]),t(\"p\",[e._v(\"给\"),t(\"code\",[e._v(\"index\")]),e._v(\"组件添加\"),t(\"code\",[e._v(\"css\")]),e._v(\"，作为业务\"),t(\"code\",[e._v(\"css\")])]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"// ./src/client/pages/index/index.scss\\n\\n.page-index-box{\\n    width: 750px;\\n}\\n\\n\\n\")])])]),t(\"p\",[t(\"code\",[e._v(\"Index\")]),e._v(\"组件导入 \"),t(\"code\",[e._v(\"css\")])]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"// ./src/client/pages/index/index.js\\n//....\\nimport './index.scss';\\n//....\\n\\n\")])])]),t(\"p\",[e._v(\"结果运行\"),t(\"code\",[e._v(\"npm run dev\")]),e._v(\"时，服务端代码打包失败。\")]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2020/1/31/16ffb3d6c0b6526e?w=958&h=414&f=png&s=192108\",alt:\"\"}})]),e._v(\" \"),t(\"p\",[e._v(\"由于组件会在双端构建，我们在组件内导入了 \"),t(\"code\",[e._v(\"css\")]),e._v(\"，而服务端\"),t(\"code\",[e._v(\"webpack\")]),e._v(\"配置文件没有配置相关的 \"),t(\"code\",[e._v(\"css loader\")]),e._v(\"，所以服务端的代码打包失败了。\")]),e._v(\" \"),t(\"h1\",{attrs:{id:\"服务端处理\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#服务端处理\"}},[e._v(\"#\")]),e._v(\" 服务端处理\")]),e._v(\" \"),t(\"ul\",[t(\"li\",[e._v(\"暴力破解法\")])]),e._v(\" \"),t(\"p\",[e._v(\"既然服务端无法处理\"),t(\"code\",[e._v(\"css\")]),e._v(\"模块，而我们也不能给服务端配置添加相关的 \"),t(\"code\",[e._v(\"css loader\")]),e._v(\",否则\"),t(\"code\",[e._v(\"css\")]),e._v(\"也会被打包进\"),t(\"code\",[e._v(\"js\")]),e._v(\"。\")]),e._v(\" \"),t(\"p\",[e._v(\"所以需要采取其他方法，这里有个取巧的方式，我们可以在服务端代码构建前干掉这行代码。\")]),e._v(\" \"),t(\"ul\",[t(\"li\",[e._v(\"如何删除这行导入？\")])]),e._v(\" \"),t(\"p\",[e._v(\"方法有很多种，要么是借助工具，要么是自己写插件。\")]),e._v(\" \"),t(\"p\",[e._v(\"在这里我们自定义一个 \"),t(\"code\",[e._v(\"babel plugin\")]),e._v(\" 来搞定。\")]),e._v(\" \"),t(\"ul\",[t(\"li\",[e._v(\"如何写 \"),t(\"code\",[e._v(\"babel plugin\")])])]),e._v(\" \"),t(\"p\",[e._v(\"我们先增加一个目录，\"),t(\"code\",[e._v(\"babel\")]),e._v(\" 下存放 \"),t(\"code\",[e._v(\"plugin\")]),e._v(\" 和 \"),t(\"code\",[e._v(\"preset\")]),e._v(\"。\")]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2019/12/13/16efece40a402185?w=293&h=368&f=png&s=29662\",alt:\"\"}})]),e._v(\" \"),t(\"p\",[e._v(\"创建一个 \"),t(\"code\",[e._v(\"js\")]),e._v(\" 文件为插件文件,插件的名称为\"),t(\"code\",[e._v(\"no-require-css\")])]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"// ./webpack/babel/plugin/no-require-css.js\\n\\n/**\\n * 删除代码中导入的 css\\n */\\nmodule.exports = function ({ types: babelTypes }) {\\n    return {\\n        name: \\\"no-require-css\\\",\\n        visitor: {\\n            ImportDeclaration(path, state) {\\n                let importFile = path.node.source.value;\\n                if(importFile.indexOf('.scss')>-1){\\n                    //如果引入了 css文件，则删除此节点\\n                    path.remove();\\n                }\\n            }\\n        }\\n    };\\n};\\n\\n\\n\")])])]),t(\"ul\",[t(\"li\",[e._v(\"配置插件\")])]),e._v(\" \"),t(\"p\",[e._v(\"在\"),t(\"code\",[e._v(\".babelrc\")]),e._v(\"内配置这个插件\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v('{\\n    \"env\": {\\n        \"node\":{\\n            \"presets\": [\\n                [\\n                    \"@babel/preset-env\",\\n                    {\\n                        \"targets\":{\\n                            \"node\":\"current\"\\n                        }\\n                    }\\n                ],\\n                \"@babel/preset-react\"\\n            ],\\n            \"plugins\": [\\n                \"@babel/plugin-proposal-class-properties\",\\n                + \"./webpack/babel/plugin/no-require-css\"          \\n            ]\\n        }\\n\\n')])])]),t(\"ul\",[t(\"li\",[e._v(\"查看结果\")])]),e._v(\" \"),t(\"p\",[e._v(\"服务可以正常启动，\"),t(\"code\",[e._v(\"css\")]),e._v(\" 已经内联到了\"),t(\"code\",[e._v(\"head\")]),e._v(\" 内。\")]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2020/1/3/16f69eb1b59b25eb?w=1005&h=452&f=png&s=140778\",alt:\"\"}})]),e._v(\" \"),t(\"h1\",{attrs:{id:\"页面抖动问题\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#页面抖动问题\"}},[e._v(\"#\")]),e._v(\" 页面抖动问题\")]),e._v(\" \"),t(\"p\",[e._v(\"我们已经实现了\"),t(\"code\",[e._v(\"css\")]),e._v(\"的渲染，但是有些勉强，效果不够好，当页面刷新或者第一次进入的时候，页面会抖动。\")]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2020/1/3/16f6a444388fd625?w=868&h=375&f=png&s=36586\",alt:\"\"}})]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2020/1/3/16f6a44fa483c564?w=868&h=375&f=png&s=38548\",alt:\"\"}})]),e._v(\" \"),t(\"p\",[e._v(\"因为第一次进入是服务端直出的 \"),t(\"code\",[e._v(\"html\")]),e._v(\" 结构，没有 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 。\")]),e._v(\" \"),t(\"p\",[t(\"code\",[e._v(\"css\")]),e._v(\" 是在客户端\"),t(\"code\",[e._v(\"js\")]),e._v(\" 代码执行后动态插入到 \"),t(\"code\",[e._v(\"head\")]),e._v(\" 内的，所以会出现抖动。\")]),e._v(\" \"),t(\"ul\",[t(\"li\",[e._v(\"如何解决这个问题呢？\")])]),e._v(\" \"),t(\"p\",[e._v(\"我们可以采用传统的方式来解决，将所有的\"),t(\"code\",[e._v(\"css\")]),e._v(\"模块 打包成一个文件，然后在服务端直出的时候带上它，作为资源文件加载。\")]),e._v(\" \"),t(\"p\",[e._v(\"例如:\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v('<link rel=\"stylesheet\" type=\"text/css\" href=\"//s1.bigerfe.com/zz-static/css/styles.04403cf0.css\">\\n\\n\\n')])])]),t(\"ul\",[t(\"li\",[e._v(\"具体如何实现？\")])]),e._v(\" \"),t(\"p\",[e._v(\"可能你会说，我们这里路过来问题有点太多了吧，这一个接一个的。\")]),e._v(\" \"),t(\"p\",[e._v(\"不用怕，慢慢来，不怕问题多，就怕没问题。\")]),e._v(\" \"),t(\"p\",[e._v(\"来吧，一起搞定他！\")]),e._v(\" \"),t(\"h1\",{attrs:{id:\"css-合并\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#css-合并\"}},[e._v(\"#\")]),e._v(\" css 合并\")]),e._v(\" \"),t(\"p\",[e._v(\"在\"),t(\"code\",[e._v(\"webpack4\")]),e._v(\"里需要使用\"),t(\"code\",[e._v(\"mini-css-extract-plugin\")]),e._v(\"插件来将 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 进行合并。\")]),e._v(\" \"),t(\"p\",[e._v(\"看下具体配置\")]),e._v(\" \"),t(\"p\",[e._v(\"将\"),t(\"code\",[e._v(\"style-loader\")]),e._v(\"替换为\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"//...\\n  {\\n    loader: MiniCssExtractPlugin.loader,\\n  }\\n//...\\n\\n\")])])]),t(\"p\",[e._v(\"设置\"),t(\"code\",[e._v(\"plugin\")])]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"  //...\\n  plugins: [\\n        new MiniCssExtractPlugin({\\n        filename: '[name].css' //设置名称\\n    })]\\n\\n\")])])]),t(\"p\",[e._v(\"上面的\"),t(\"code\",[e._v(\"[name]\")]),e._v(\"为资源的名称，会使用当前配置的\"),t(\"code\",[e._v(\"entry\")]),e._v(\"的名称，所以我们调整下\"),t(\"code\",[e._v(\"entry\")]),e._v(\"定义,增加入口\"),t(\"code\",[e._v(\"main\")])]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"//...\\n entry:{\\n        main: resolvePath('../src/client/app/index.js'), //入口文件\\n    }\\n//...\\n\\n\")])])]),t(\"p\",[e._v(\"同时将\"),t(\"code\",[e._v(\"js\")]),e._v(\"的 \"),t(\"code\",[e._v(\"bundle\")]),e._v(\" 的名称改为占位\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v(\"  output: {\\n        filename: '[name].js',\\n        path: resolvePath('../dist/static')\\n    }\\n\\n\")])])]),t(\"h2\",{attrs:{id:\"服务端调整\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#服务端调整\"}},[e._v(\"#\")]),e._v(\" 服务端调整\")]),e._v(\" \"),t(\"p\",[e._v(\"经过上面的配置，我们已经将所有的 \"),t(\"code\",[e._v(\"css\")]),e._v(\"打包到一个文件内。\")]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2020/1/3/16f6a4c2f4a00ef5?w=269&h=168&f=png&s=11221\",alt:\"\"}})]),e._v(\" \"),t(\"p\",[e._v(\"在服务端只需将\"),t(\"code\",[e._v(\"main.css\")]),e._v(\"作为 \"),t(\"code\",[e._v(\"link\")]),e._v(\" 直出即可。\")]),e._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[e._v('// ./src/server/middlewares/react-ssr.js\\n\\n//...\\n    ctx.body=`<!DOCTYPE html>\\n<html lang=\"en\">\\n<head>\\n    <meta charset=\"UTF-8\">\\n    <title>${tdk.title}</title>\\n    <meta name=\"keywords\" content=\"${tdk.keywords}\" />\\n    <meta name=\"description\" content=\"${tdk.description}\" />\\n    + <link rel=\"stylesheet\" type=\"text/css\" href=\"/main.css\" />\\n</head>\\n\\n//...\\n\\n\\n')])])]),t(\"p\",[e._v(\"启动服务，页面已正常显示。\")]),e._v(\" \"),t(\"p\",[e._v(\"看下具体效果\")]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2020/1/3/16f6a4eeffa49502?w=500&h=375&f=png&s=92471\",alt:\"\"}})]),e._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://user-gold-cdn.xitu.io/2020/1/3/16f6a4feb128f170?w=500&h=375&f=png&s=39298\",alt:\"\"}})]),e._v(\" \"),t(\"h1\",{attrs:{id:\"小结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#小结\"}},[e._v(\"#\")]),e._v(\" 小结\")]),e._v(\" \"),t(\"p\",[e._v(\"本节我们主要实现\"),t(\"code\",[e._v(\"react ssr\")]),e._v(\"中的 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 的支持和处理。\")]),e._v(\" \"),t(\"p\",[e._v(\"客户端的处理，配置和我们以往单页开发中的配置没什么区别，主要是服务端方面的处理。\")]),e._v(\" \"),t(\"p\",[e._v(\"我们采用的方式比较直接，服务端构建前将导入的\"),t(\"code\",[e._v(\"css\")]),e._v(\"模块代码移除，然后客户端配置将 \"),t(\"code\",[e._v(\"css\")]),e._v(\" 提取到一个文件内，然后将 \"),t(\"code\",[e._v(\"css\")]),e._v(\"作为\"),t(\"code\",[e._v(\"link\")]),e._v(\"直出到浏览器端，解决了页面的抖动问题。\")]),e._v(\" \"),t(\"p\",[e._v(\"本节代码已上传\")]),e._v(\" \"),t(\"p\",[t(\"a\",{attrs:{href:\"https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-css\",target:\"_blank\",rel:\"noopener noreferrer\"}},[e._v(\"https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-css\"),t(\"OutboundLink\")],1)]),e._v(\" \"),t(\"p\",[e._v(\"感谢你的阅读。\")]),e._v(\" \"),t(\"p\",[e._v(\"如果有问题欢迎留言，也欢迎在留言区留下你的想法和思考。\")])])}),[],!1,null,null,null);s.default=n.exports}}]);","extractedComments":[]}