## å¯¼è¯»

æœ¬èŠ‚æ ‡é¢˜ï¼šã€Œè£…ä¿®é˜¶æ®µã€- åŒæœåŠ¡æ¨¡å¼çƒ­æ›´æ–°

æœ¬èŠ‚ä¸»æ—¨ï¼šå¼€å‘ç¯å¢ƒä½“éªŒå†åº¦ä¼˜åŒ–å‡çº§ï¼Œå®ç°æ¨¡å—çƒ­æ›¿æ¢æœºåˆ¶

æœ¬èŠ‚é…å¥—ä»£ç ï¼š

[https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-HMR](https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-HMR)

# æ­£æ–‡

ä¸Šä¸€èŠ‚æˆ‘ä»¬å®Œæˆäº†ç”Ÿäº§ç¯å¢ƒçš„é…ç½®ï¼Œä»æœ¬èŠ‚å¼€å§‹ä¸€èµ·æ¥åšä¸€äº›â€œè£…ä¿®â€çš„å·¥ä½œï¼Œè®©åº”ç”¨éª¨æ¶çš„å¼€å‘ä½“éªŒæ›´å¥½,åŒæ—¶ä¹Ÿæ˜¯è§£å†³æˆ‘ä»¬ä¹‹å‰ç•™ä¸‹çš„å‘ã€‚

è‰¯å¥½çš„å¼€å‘ä½“éªŒå¯ä»¥å¤§å¤§æé«˜æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ï¼Œç›®å‰æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºé™·ï¼Œå¼€å‘ç¯å¢ƒä¸­éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ¥çœ‹æ•ˆæœã€‚

è€Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ - æå®šä»–ï¼

ä½¿ç”¨`webpack --watch`æ¥åŠ¨æ€ç›‘å¬å‰ç«¯æ–‡ä»¶çš„æ”¹å˜å¹¶å®æ—¶æ‰“åŒ…ï¼Œè¾“å‡ºæ–°`bundle.js`æ–‡ä»¶ï¼Œè¿™æ ·æ–‡ä»¶å¤šäº†ä¹‹åæ‰“åŒ…é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œæ­¤å¤–è¿™æ ·çš„æ‰“åŒ…æ–¹å¼ä¸èƒ½åšåˆ°`hot replace`ï¼Œå³æ¯æ¬¡`webpack`ç¼–è¯‘ä¹‹åéœ€è¦æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨ã€‚

æ‰€ä»¥æœ¬èŠ‚æˆ‘ä»¬å°±æ˜¯ç”¨çƒ­æ›´æ–°æœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

# çƒ­æ›´æ–°

å¯¹äºçƒ­æ›´ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰æ‰€äº†è§£ï¼Œä¸€ç§æ˜¯çƒ­é‡è½½ï¼Œä¸€ç§æ˜¯æ¨¡å—çƒ­æ›¿æ¢ã€‚

æˆ‘ä»¬è¿™é‡Œè¦å®ç°çš„æ˜¯æ¨¡å—çƒ­æ›¿æ¢ã€‚

# webpack-dev-server

å› ä¸ºè¯¥æ¨¡å—å·²ç»å†…ç½®äº†çƒ­æ›´æ–°æœºåˆ¶ï¼Œåªéœ€è¦è¿›è¡Œä¸€äº›ç®€å•çš„é…ç½®å°±èƒ½å°†è¿™ä¸ªç‰¹æ€§ç»§æ‰¿åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­ã€‚

æ‰€ä»¥å¼€å‘ç¯å¢ƒä¸­å®ç°çƒ­æ›´æ–°æ¨èä½¿ç”¨`webpack-dev-server`ã€‚

ps:`webpack-dev-server`åé¢éƒ½ä½¿ç”¨`wds`ç®€ç§°æ¥ä»£æ›¿

è¯¥åº“çš„ä½œç”¨ä¸»è¦æ˜¯ç”¨æ¥æä¾›é™æ€èµ„æºæ–‡ä»¶çš„æ›´æ–°å’Œè®¿é—®ã€‚å…¶å†…éƒ¨ä¼šå¯åŠ¨ä¸€ä¸ªåŸºäº`express`çš„`http`æœåŠ¡å™¨ã€‚ è¯¥`http`æœåŠ¡å’Œæµè§ˆå™¨ä¹‹é—´ä½¿ç”¨`websocket`è¿›è¡Œå®æ—¶é€šè®¯ã€‚å½“åŸå§‹æ–‡ä»¶ä½œå‡ºæ”¹åŠ¨åï¼Œ`wds`ä¼šå®æ—¶ç¼–è¯‘ï¼Œä½†æ˜¯æœ€åçš„æ„å»ºæ–‡ä»¶å¹¶æ²¡æœ‰è¾“å‡ºåˆ°ç¡¬ç›˜ï¼Œè€Œæ˜¯å…¨éƒ¨è½½å…¥å†…å­˜ï¼Œçœå»äº†æ¯æ¬¡å¯¹ç£ç›˜çš„ `io`ï¼Œæ‰€ä»¥æ€§èƒ½ä¸Šä¹Ÿè¾ƒä»¥å¾€çš„æ–¹å¼æœ‰å¾ˆå¤§çš„æå‡ã€‚

å¯åŠ¨`webpack-dev-server`æœåŠ¡æœ‰2ç§æ–¹å¼ï¼š

1.  é€šè¿‡ `cmd line`
    
2.  é€šè¿‡`Node.js API`
    

ä¸ºäº†å¯ä»¥æ›´åŠ çµæ´»æ§åˆ¶ï¼Œæˆ‘ä»¬é‡‡ç”¨`API`æ–¹å¼æ¥å¯åŠ¨ã€‚

å¦å¤–è¿˜éœ€è¦ç»“åˆ`react-hot-loader`åº“æ¥å®ç° `react` å¼€å‘ç¯å¢ƒä¸‹çš„çƒ­æ›´æ–°ã€‚

# å…·ä½“å®æ–½

## ç«¯å£çº¦å®š

æˆ‘ä»¬çº¦å®š`webpack-dev-server`æœåŠ¡ç«¯å£ä¸º`9002`ï¼Œåº”ç”¨éª¨æ¶çš„`node server`å¯åŠ¨ç«¯å£ä¸º`9001`,ä¿æŒä¸å˜ã€‚

ps:è¿™äº›ç«¯å£å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½æ¥è°ƒæ•´ã€‚

## å®‰è£…æ¨¡å—

```
npm i webpack-dev-server -D

```

`react-hot-loader` å¯ä»¥ç»“åˆ `wds` å®ç°çƒ­æ›´æ–°è¿‡ç¨‹ä¸­ä¿å­˜ `react` ç»„ä»¶çš„çŠ¶æ€ä¸ä¸¢å¤±

```
npm i react-hot-loader -D

```

## react-hot-loader é…ç½®

`.babelrc` å†…å¢åŠ  `react-hot-loader/babel`

```
// .babelrc
{
  "plugins": ["react-hot-loader/babel"]
}

```

*   æ ¹ç»„ä»¶ä½¿ç”¨çƒ­å¯¼å‡º

```
// src/client/app/layout.js

import { hot } from 'react-hot-loader/root';
class Index extends React.Component{
//...
}
export default hot(Index);

```

*   å®‰è£…`@hot-loader/react-dom`

å®ƒæ›¿æ¢äº†åŒä¸€ç‰ˆæœ¬çš„`react-dom`åŒ…ï¼Œä½¿ç”¨äº†é¢å¤–çš„è¡¥ä¸æ¥æ”¯æŒçƒ­é‡æ–°åŠ è½½ã€‚

ç›´æ¥ä½¿ç”¨`react-dom`ï¼Œæ§åˆ¶å°ä¼šå‡ºç°ä¸‹é¢çš„è­¦å‘Š

![](https://user-gold-cdn.xitu.io/2019/12/18/16f17aa1a097f7fc?w=1272&h=172&f=png&s=52679)

*   `webpack`é…ç½®å…¥å£`entry`è°ƒæ•´

```
//webpack.dev.config
module.exports = {
  entry: {
        main:['react-hot-loader/patch',resolvePath('../src/client/app/index.js'), //å…¥å£æ–‡ä»¶
    }

```

## wds é…ç½®

é€šè¿‡ `api` æ–¹å¼å¯åŠ¨ `wds` æœåŠ¡æ—¶ï¼Œä¼šå¿½ç•¥`webpack.dev.config`å†…çš„é…ç½®ï¼Œéœ€è¦å°†é…ç½®ä½œä¸ºå‚æ•°ä¼ é€’ç»™`WebpackDevServer`ã€‚

åˆ›å»ºä¸€ä¸ª `wds` é…ç½®æ–‡ä»¶

```
// webpack/scripts/webpack-dev-server.config.js

const path  = require('path');

module.exports = function (port,publicPath) {
    return {
        quiet: true,//ä¸æ˜¾ç¤ºæ„å»ºæ—¥å¿—
        contentBase: path.resolve(__dirname, '../../dist/static'),
        publicPath: publicPath,//å¿…é¡»å’Œ webpack.dev.config é…ç½®ä¸€è‡´
        hot: true,
        progress:true,
        open: false,
        compress: true,
        watchOptions: {
            ignored: /node_modules/,
            //å½“ç¬¬ä¸€ä¸ªæ–‡ä»¶æ›´æ”¹ï¼Œä¼šåœ¨é‡æ–°æ„å»ºå‰å¢åŠ å»¶è¿Ÿã€‚
            //è¿™ä¸ªé€‰é¡¹å…è®¸ webpack å°†è¿™æ®µæ—¶é—´å†…è¿›è¡Œçš„ä»»ä½•å…¶ä»–æ›´æ”¹éƒ½èšåˆåˆ°ä¸€æ¬¡é‡æ–°æ„å»ºé‡Œã€‚ä»¥æ¯«ç§’ä¸ºå•ä½ï¼š
            aggregateTimeout: 500,
            //æŒ‡å®šæ¯«ç§’ä¸ºå•ä½è¿›è¡Œè½®è¯¢
            poll: 500
        }
    }
}

```

## ç›¸å…³ api è°ƒç”¨

åœ¨ `webpack/scripts`ä¸‹åˆ›å»º`wds-start.js`æ–‡ä»¶ï¼Œç”¨äºå¯åŠ¨ `wds` æœåŠ¡ã€‚

1.  è·å¾— `webpack compiler`

`wds` éœ€è¦å’Œ `webpack` ç›¸ç»“åˆæ‰èƒ½å·¥ä½œ

```
//webpack dev ç¯å¢ƒé…ç½®
const clientConfig = require('../webpack.dev.config');

// è·å¾—webpack compiler
function getWebPackCompiler() {
    return webpack(clientConfig);
}


```

2.  åˆ›å»º `wds` æœåŠ¡

è¿™é‡Œçš„æœåŠ¡æŒ‡çš„æ˜¯ `wds` å†…éƒ¨ä¼šå¯åŠ¨ä¸€ä¸ª `http server`ï¼Œç”¨æ¥æ”¯æŒ `socket` å’Œ èµ„æºè®¿é—®ã€‚

```
//wds é…ç½®
const getWdsConfig = require('./webpack-dev-server.config');

//åˆ›å»º wds æœåŠ¡
function createWdsServer() {

    let compiler = getWebPackCompiler();

     compiler.hooks.done.tap('done', function (data) {
        console.log('\n wds server compile done'); //ç¼–è¯‘å®Œæˆæ—¶çš„æç¤º 
    });
    
    return new WebpackDevServer(compiler, getWdsConfig(clientConfig.output.publicPath));
}

```

3.  å¯åŠ¨ `wds` æœåŠ¡

`createWdsServer`ä¼šè¿”å›ä¸€ä¸ª `http server` å®ä¾‹,è¿™é‡Œå¯åŠ¨çš„ç«¯å£è®¾ç½®ä¸º`9002`ã€‚

```
// å¯åŠ¨ WebpackDevServer

function runWdsServer() {

    let devServer = createWdsServer();
    let port=9002;//wds æœåŠ¡ç«¯å£
    devServer.listen(port,'localhost',err => {
        if (err) {
            return console.log(err);
        }
        console.log(chalk.cyan('Starting the development node server...\n'));
    
        console.log('ğŸš€ started');
    });

}

runWdsServer();


```

## å…³é”® - é…ç½® publicPath

`wds` å’Œ `webpack.dev.config` çš„`publicPath`å¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™çƒ­æ›´æ–°ä¼šæ— æ•ˆï¼Œä¼šé»˜è®¤è¯·æ±‚åˆ°`node server`ï¼Œå¯¼è‡´é™æ€èµ„æºè®¿é—®æ— æ•ˆã€‚

ä¸‹é¢å¯¹`webpack.dev.config.js`è¿›è¡Œè°ƒæ•´ï¼Œç«¯å£æŒ‡å‘çš„æ˜¯`wds`çš„ç«¯å£`9002`ï¼Œå› ä¸ºæ‰€æœ‰çš„é™æ€èµ„æºç°åœ¨æ˜¯ç”±`wds`æä¾›çš„ã€‚

```
// webpack.dev.config.js

 output: {
     //...
    publicPath: 'http://localhost:9002/'
}

```

## é…ç½® npm scripts å‘½ä»¤

```
"wds:watch": "BABEL_ENV=development node ./webpack/scripts/wds-start.js",

```

```
npm run wds:watch

```

![](https://user-gold-cdn.xitu.io/2019/12/17/16f1390440cbdf0a?w=813&h=153&f=png&s=39345)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºç¼–è¯‘å·²ç»é€šè¿‡ï¼Œè€Œä¸”æ”¯æŒå®æ—¶ç¼–è¯‘ï¼Œä½†æ˜¯çƒ­æ›´æ–°è¿˜çœ‹ä¸å‡ºæ¥ã€‚

## è°ƒæ•´å¼€å‘ç¯å¢ƒå¯åŠ¨å‘½ä»¤

```
// webpack/start.js

//ç§»é™¤ webpack -watch ç›‘å¬
- spawn('npm', ['run', 'fe:watch'], { stdio: 'inherit' });

//å¢åŠ  wds ç›‘å¬
+ spawn('npm', ['run', 'wds:watch'], { stdio: 'inherit' });


```

## å®¢æˆ·ç«¯æ¸²æŸ“å…¥å£ä»£ç é…ç½®

```
// src/client/app/index.js

//åªæœ‰åœ¨å¼€å‘ç¯å¢ƒæ‰å¯ç”¨çƒ­æ›´æ–°
if (process.env.NODE_ENV==='development' &&  module.hot) {
    module.hot.accept();
}

```

## æ›´æ”¹ `node server` çš„ `js` è„šæœ¬åœ°å€

å› ä¸ºæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯åŒæœåŠ¡æ¨¡å¼

*   `wds` æœåŠ¡æä¾›é™æ€èµ„æºæœåŠ¡
*   `node server` æä¾› ssr èƒ½åŠ›

æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†é™æ€èµ„æºçš„åœ°å€æŒ‡å‘ `wds` æœåŠ¡çš„`9002`ç«¯å£

```
// src/server/common/assets.js

- let devHost = '//localhost:9001';
+ let devHost = '//localhost:9002';

//...


```

# æµ‹è¯• - å¯åŠ¨çƒ­æ›´æ–°

æ‰§è¡Œ `npm run dev`

çœ‹ä¸‹å›¾ï¼Œ`socket`å·²æˆåŠŸå»ºç«‹é“¾æ¥,åé¢åªè¦æ›´æ–°äº†æ–‡ä»¶å°±ä¼šè‡ªåŠ¨æ›´æ–°é¡µé¢ï¼Œä¸”é¡µé¢ä¸ä¼šåˆ·æ–°,ç»„ä»¶çš„çŠ¶æ€ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

![](https://user-gold-cdn.xitu.io/2019/12/17/16f13a6dfe26dcda?w=1184&h=174&f=png&s=21443)

![](https://user-gold-cdn.xitu.io/2019/12/17/16f13a94a4715d96?w=1190&h=312&f=png&s=62696)

# å°ç»“

æœ¬åœ°å¼€å‘æœåŠ¡å¯åŠ¨åï¼Œä¼šå¯åŠ¨ä¸‰ä¸ªè¿›ç¨‹ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹è¯´çš„åŒæœåŠ¡ï¼Œ`wds`æœåŠ¡å’Œ`node server`,åœ¨è¿™ä¸¤ä¸ªæœåŠ¡çš„é…åˆä¸‹å®Œæˆäº†å¼€å‘ç¯å¢ƒçš„çƒ­æ›´æ–°å¼€å‘ä½“éªŒã€‚

1.  `wds`æœåŠ¡è¿›ç¨‹ï¼Œæä¾›é™æ€èµ„æºè®¿é—®å’Œçƒ­æ›´æ–°åŠŸèƒ½
2.  æœåŠ¡ç«¯ä»£ç ç›‘å¬è¿›ç¨‹
3.  `node http server` æä¾›`react ssr`èƒ½åŠ›

`node server` ä¼šä»`wds 9002`ç«¯å£æœåŠ¡ä¸ŠåŠ è½½é™æ€èµ„æºã€‚

å¥½äº†ï¼Œæœ¬å°èŠ‚åˆ°æ­¤ç»“æŸï¼Œå¿«æ¥è¯•è¯•çƒ­æ›´æ–°å§ã€‚

æœ¬èŠ‚ä»£ç å·²ä¸Šä¼ 

[https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-HMR](https://github.com/Bigerfe/koa-react-ssr/tree/better/packages/my-react-ssr-HMR)

æ„Ÿè°¢ä½ çš„é˜…è¯»ã€‚

å¦‚æœæœ‰é—®é¢˜æ¬¢è¿ç•™è¨€ï¼Œä¹Ÿæ¬¢è¿åœ¨ç•™è¨€åŒºç•™ä¸‹ä½ çš„æƒ³æ³•å’Œæ€è€ƒã€‚